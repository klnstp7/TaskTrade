@model Peacock.PEP.Model.InquiryModel

@{
    ViewBag.Title = "打印询价单！若要保存编辑过的询价单，请在关闭此页面之后点击询价页面的“保存”按钮";
    Layout = "~/Views/Shared/_LayoutPage.cshtml";
}

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
<link href="~/Content/plug-in/umeditor/themes/default/css/umeditor.min.css" rel="stylesheet" />
<script src="~/Content/plug-in/umeditor/umeditor.config.js"></script> 
<script src="~/Content/plug-in/umeditor/umeditor.js"></script> 
<script src="~/Content/plug-in/umeditor/lang/zh-cn/zh-cn.js"></script>
<script src="~/Content/plug-in/jquery/jquery.contextmenu.js?r=" + math.random()></script>
<style type="text/css">
    table {
        border-collapse: collapse;
        border-spacing: 0;
        border-left: 1px solid #888;
        border-top: 1px solid #888;
    }

    th, td {
        border-top: 1px solid #888;
        border-left: 1px solid #888;
        border-right: 1px solid #888;
        border-bottom: 1px solid #888;
        height: 40px;
        padding: 3px 5px;
        font-size: 14px;
        font-family: "新宋体";
    }

    .contextMenuPlugin {
        -webkit-user-select: none;
        display: none;
        font-family: tahoma, arial, sans-serif;
        font-size: 11px;
        position: absolute;
        left: 100px;
        top: 100px;
        min-width: 100px;
        list-style-type: none;
        margin: 0;
        padding: 0;
        background-color: #f7f3f7;
        border: 2px solid #f7f7f7;
        outline: 1px solid #949694;
    }

        .contextMenuPlugin > li {
            margin: 0 0 0 0;
            padding: 1px;
            background-repeat: no-repeat;
        }

            .contextMenuPlugin > li > a {
                position: relative;
                display: block;
                padding: 3px 3px 3px 28px;
                color: ButtonText;
                text-decoration: none;
                margin: 1px;
            }

                .contextMenuPlugin > li > a img {
                    position: absolute;
                    left: 3px;
                    margin-top: -2px;
                    width: 16px;
                    height: 16px;
                }

                .contextMenuPlugin > li > a:hover {
                    border: 1px solid #fffbff;
                    outline: 1px solid #b5d3ff;
                    margin: 0;
                    background: -moz-linear-gradient(top, rgba(239,239,255,0.5) 0%, rgba(223,223,255,0.5) 100%); /* FF3.6+ */
                    background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(239,239,255,0.5)), color-stop(100%,rgba(223,223,255,0.5))); /* Chrome,Safari4+ */
                    background: -webkit-linear-gradient(top, rgba(239,239,255,0.5) 0%,rgba(223,223,255,0.5) 100%); /* Chrome10+,Safari5.1+ */
                    background: -o-linear-gradient(top, rgba(239,239,255,0.5) 0%,rgba(223,223,255,0.5) 100%); /* Opera11.10+ */
                    background: -ms-linear-gradient(top, rgba(239,239,255,0.5) 0%,rgba(223,223,255,0.5) 100%); /* IE10+ */
                    filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#80efefff', endColorstr='#80dfdfff',GradientType=0 ); /* IE6-9 */
                    background: linear-gradient(top, rgba(239,239,255,0.5) 0%,rgba(223,223,255,0.5) 100%); /* W3C */
                    cursor: default;
                }

            .contextMenuPlugin > li.divider {
                border-top: 1px solid #e7e3e7;
                border-bottom: 1px solid #ffffff;
                height: 0;
                padding: 0;
                margin: 5px 0 5px 27px;
            }

        .contextMenuPlugin > .header {
            background: rgb(90,90,90); /* Old browsers */
            background: -moz-linear-gradient(top, rgba(90,90,90,1) 0%, rgba(20,20,20,1) 100%); /* FF3.6+ */
            background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(90,90,90,1)), color-stop(100%,rgba(20,20,20,1))); /* Chrome,Safari4+ */
            background: -webkit-linear-gradient(top, rgba(90,90,90,1) 0%,rgba(20,20,20,1) 100%); /* Chrome10+,Safari5.1+ */
            background: -o-linear-gradient(top, rgba(90,90,90,1) 0%,rgba(20,20,20,1) 100%); /* Opera11.10+ */
            background: -ms-linear-gradient(top, rgba(90,90,90,1) 0%,rgba(20,20,20,1) 100%); /* IE10+ */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#5a5a5a', endColorstr='#141414',GradientType=0 ); /* IE6-9 */
            background: linear-gradient(top, rgba(90,90,90,1) 0%,rgba(20,20,20,1) 100%); /* W3C */
            position: relative;
            cursor: default;
            padding: 3px 3px 3px 3px;
            color: #ffffff;
        }

        .contextMenuPlugin > .gutterLine {
            position: absolute;
            border-left: 1px solid #e7e3e7;
            border-right: 1px solid #ffffff;
            width: 0;
            top: 0;
            bottom: 0;
            left: 26px;
            z-index: 0;
        }
</style>

<div id="ShowInfo" style="overflow-y:auto;">
    <table style="border:1px solid #000000; width:90%;margin-right:auto;margin-left:auto">
        <tr>
            <td colspan="5" style="text-align: center; font-size: 30px; border-bottom-width:0px;"><strong>房地产抵押评估询价单</strong></td>
        </tr>
        <tr>
            <td colspan="5" style="font-size:10px; border-top-width:0px;" align="right">询字第<span id="InquiryNo"></span>号&nbsp;</td>
        </tr>
        <tr>
            <td width="20%"><b>估价使用方</b></td>
            <td colspan="2" id="AppraiseUse"></td>
            <td width="20%"><b>估价委托人</b></td>
            <td id="AppraiseDelegatePerson" width="20%"></td>
        </tr>
        <tr>
            <td><b>估价对象</b></td>
            <td colspan="4" id="ResidentialAddress"></td>
        </tr>
        <tr>
            <td><b>估价目的</b></td>
            <td colspan="4" id="AppraisePurpose"></td>
        </tr>
        <tr>
            <td><b>价值时点</b></td>
            <td colspan="4" id="AppraiseDate"></td>
        </tr>
        <tr>
            <td rowspan="4" width="20%"><b>基础信息</b></td>
            <td width="20%"><b>小区名称</b></td>
            <td id="ResidentialAreaName" width="20%"></td>
            <td width="20%"><b>建筑面积</b></td>
            <td id="BuildingArea" width="20%"></td>
        </tr>
        <tr>
            <td>设定朝向</td>
            <td id="Toword"></td>
            <td>设定房屋结构</td>
            <td id="HouseStruct"></td>
        </tr>
        <tr>
            <td>设定用途</td>
            <td id="SetPurpose"></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td><b>他项权利状况</b></td>
            <td colspan="3" id="TD_OtherPower"></td>
        </tr>
        <tr>
            <td rowspan="6"><b>估价结果</b></td>
            <td>单价</td>
            <td colspan="3">¥：<span id="InquiryPrice"></span>元/平方米</td>
        </tr>
        <tr>
            <td>总价</td>
            <td colspan="3">¥：<span id="InquiryResult"></span>万元</td>
        </tr>
        <tr>
            <td>大写金额</td>
            <td colspan="3">¥：<span id="UpperAmount"></span>元</td>
        </tr>
        <tr>
            <td>预计处置税费</td>
            <td colspan="3">¥：<span id="DisposeFee"></span>万元&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;（盖章）</td>
        </tr>
        <tr>
            <td>应补地价</td>
            <td colspan="3">¥：<span id="LandPremium"></span>万元</td>
        </tr>
        <tr>
            <td>扣后净值</td>
            <td colspan="3">¥：<span id="MinusNetWorth"></span>万元</td>
        </tr>
        <tr>
            <td><b>特殊事项说明</b></td>
            <td colspan="4" id="SpecialRemark"></td>
        </tr>
        <tr style="border-bottom-width:0px;">
            <td><b>询价单有效期</b></td>
            <td colspan="4">
                本价格咨询自出具之日起<span id="ValidityDate"></span>内有效，但在此期间市场变化较快或国家经济形式、城市规划、相关税费和银行利率发生变化，估价结果应重新评估。
            </td>
        </tr>
        <tr style="border-width:0px;">
            <td colspan="5" align="right" style="border-width:0px;"><span id="AppraiseOrg" style="margin-right:40px"></span></td>
        </tr>
        <tr style="border-width:0px;">
            <td colspan="5" align="right" style="border-width:0px;"><span id="IssueDate" style="margin-right:40px"></span></td>
        </tr>
        <tr style="border-width:0px;">
            <td align="right" colspan="5" style="border-width:0px;"><span style="margin-right:40px">（盖章）</span></td>
        </tr>
    </table>
</div>
<div class="layer_notice" style="display: none;" id="addparamsdialog">
    <h2><i class="fa fa-close pull-right" style="" onclick="CloseParamDialog();"></i><span style="">修改内容</span></h2>
    <table width="100%">
        <tr>
            <td>
                <div id="myEditor" style="width:650px;height:300px;">
                </div>
            </td>
        </tr>
        <tr><td align="center"><button type="button" id="submit_params" class="btn-blue" onclick="SaveMsg()" style="margin-top:12px;">保存</button></td></tr>
    </table>
</div>
<script type="text/javascript">
var um;
var CurrentTD = null;//保存当前点编辑的TD
var ContorlId = "";//保存当前编辑的控件ID
$(function () {
    $(document.body).css("overflow-y","hidden");
    $("#ShowInfo").height($(window).height() -15);
    $("#ShowInfo").find("tr").each(function () {
        var tds = $(this).find("td");
        if (tds.length == 6) {
            [tds[0], tds[2], tds[4]].forEach(function (item) {
                $(item).css("width", 80);
            });
            [tds[1], tds[3], tds[5]].forEach(function (item) {
                $(item).css("width", 100);
            });
        }
    });
    $($("#ShowInfo").find("tr")[1]).find("td").each(function () {
        $(this).css("height", 10);
    });
    var SpecialRemarkDefault = "<ul> <li> 1、本次询价单所依据的资料由委托方提供，如相关数据发生变化，估价结果需做相应调整。</li>";
    SpecialRemarkDefault += "<li> 2、本次询价单意见仅供委托方内部参考，不得用在其他用途。</li>";
    SpecialRemarkDefault += "<li>3、本次询价单结果未对估价对象进行实地现场勘察，如与实际不符，会对初评结果产生影响，相关数据会发生变化，估价结果需做相应调整。本次询价结果已对估价对象进行实地现场勘察。</li>";
    SpecialRemarkDefault += "<li>4、本次出具的询价单，只用于委托人评估了解房地产抵押价值参考使用，其估价结果的有效期为三个月，询价单超过三个月的请委托方从新复估。</li>";
    SpecialRemarkDefault += "<li>5、该价值仅为询价结果，最终价值水平以委托方补充相关资料后本公司出具的正式评估报告为准，本次询价单不能作为办理抵押登记的有效文件，且委托方应以本公司出具的正式报告作为有效文件存档。</li>";
    SpecialRemarkDefault += "<li>6、若改变估价目的、价值时点、估价假设前提及使用条件，估价结果亦会发生变化，需向本估价机构咨询后重新出具询价单。由此对询价单使用人造成的损失，估价机构不承担任何责任。</li>";
    SpecialRemarkDefault += "<li>7、估价结果是反映估价对象在本次估价目的下的房地产价值，估价中未考虑国家宏观经济政策发生变化、市场供应关系变化、市场结构转变、遇有自然力和其他不可抗力等因素对房地产价值的影响，也没有考虑估价对象将来可能承担违约责任的事宜，以及特殊交易方式下的特殊交易价格等对评估价值的影响。当上述条件发生变化时，估价结果一般也会发生变化。</li>";
    SpecialRemarkDefault += "</ul>";
    //读取父窗体的值
    var printdata = window.opener.WindowsData;
    //询价Id 
    for (var i = 0; i < printdata.length; i++) {
        if (printdata[i].name == "OtherPower" && $("#TD_OtherPower").text() == "") {
            if (printdata[i].value == "true" || printdata[i].value == "True") {
                $("#TD_OtherPower").text("根据《房地产抵押估价指导意见》的有关规定，房地产抵押价值等于假定未设立法定优先受偿权利下的市场价值减去房地产估价师知悉的法定优先受偿款。估价对象于价值时点存在抵押他项权利，本次评估以原有的抵押权注销后再设立新的抵押权为假设前提，故不考虑此项优先受偿款。");
            }
            else {
                $("#TD_OtherPower").text("根据《房地产抵押估价指导意见》的有关规定，房地产抵押价值等于假定未设立法定优先受偿权利下的市场价值减去房地产估价师知悉的法定优先受偿款。根据估价委托人提供的资料，估价对象不存在估价师知悉的法定优先受偿款，故法定优先受偿款为0元。");
            }
            $("#TD_OtherPower").bind('dblclick', function () { EditSpecialRemark(this, true) });
        }
        else if (printdata[i].name == "SpecialRemark") {
            if (printdata[i].value != "") {
                $("#SpecialRemark").html(Base64.decode(printdata[i].value));
            }
            else {
                $("#SpecialRemark").html(SpecialRemarkDefault);
            }
            $("#SpecialRemark").bind('dblclick', function () { EditSpecialRemark(this, true) });
        }
        else if (printdata[i].name == "OtherPowerDesc" && printdata[i].value != "") {
            $("#TD_OtherPower").html(Base64.decode(printdata[i].value));
            $("#TD_OtherPower").bind('dblclick', function () { EditSpecialRemark(this, true) });
        }
        else {
            //大写金额不让修改
            if (printdata[i].name == "UpperAmount") {
                $("#" + printdata[i].name).html(printdata[i].value);
                continue;
            }
            $("#" + printdata[i].name).html(printdata[i].value);
            if ($("#" + printdata[i].name).is("span")) {
                $("#" + printdata[i].name).parent().bind('dblclick', function () { EditSpecialRemark(this, false) });
            }
            else {
                $("#" + printdata[i].name).bind('dblclick', function () { EditSpecialRemark(this, true) });
            }
        }
        if ($("#" + printdata[i].name).is("span")) {
            $("#" + printdata[i].name).parent().attr("title", "双击进行编辑,若要保存编辑过的内容，请在关闭此页面之后点击询价页面的“保存”按钮");
        }
        else {
            $("#" + printdata[i].name).attr("title", "双击进行编辑,若要保存编辑过的内容，请在关闭此页面之后点击询价页面的“保存”按钮");
        }
        $("#TD_OtherPower").attr("title", "双击进行编辑,若要保存编辑过的内容，请在关闭此页面之后点击询价页面的“保存”按钮");
    }
    $(this).contextPopup({
        title: '选择菜单',
        items: [
            {
                label: '打印', icon: '/Content/images/receipt-text.png', action: function () {
                    $(".contextMenuPlugin").hide();
                    window.print();
                }
            },
            {
                label: '打印并保存', icon: '/Content/images/receipt-text.png', action: function () {
                    $(".contextMenuPlugin").hide();
                    window.opener.SaveInquiry(false);
                    window.print();
                }
            },
            {
                label: '关闭页面', icon: '/Content/images/receipt-text.png', action: function () {
                    window.close();
                }
            }
        ]
    });
    um = UM.getEditor('myEditor');


});
var project;
function EditSpecialRemark(obj, isself) {
    CurrentTD = obj;
    ContorlId = isself ? $(obj).attr("id") : $(obj).children().attr("id");
    var Settext = isself ? $(obj).html() : $(obj).children().text();
    UM.getEditor('myEditor').setContent(Settext, false);
    project = layer.open({
        type: 1,
        shade: [0.3, "#070707"],
        closeBtn: 0,
        area: ['700px', '500px'],
        title: false, //不显示标题
        content: $('#addparamsdialog') //捕获的元素
    });
}
function SaveMsg() {
    var content = UM.getEditor('myEditor').getContent();
    if (!$("#" + ContorlId).is("span")) {
        $("#" + ContorlId).html(content);
    }
    else {
        $("#" + ContorlId).text(content.replace("<p>", "").replace("</p>", ""));
    }
    var parentcontent = $("#" + ContorlId).text();
    $("#" + ContorlId, window.opener.document).val(parentcontent);
    if (ContorlId == "InquiryResult") {
        $("#UpperAmount").text(digitUppercase(parentcontent));
        $("#UpperAmount", window.opener.document).val(digitUppercase(parentcontent));
        $("#Lb_UpperAmount", window.opener.document).html(digitUppercase(parentcontent));//设置列表大写金额的显示
    }
    if (ContorlId == "SpecialRemark") {
        //加密保存在数据库中
        $("#SpecialRemark", window.opener.document).val(Base64.encode($("#" + ContorlId).html()));//设置特殊事项的值，用于数据库保存
    }
    if (ContorlId == "TD_OtherPower") {
        $("#OtherPowerDesc", window.opener.document).val(Base64.encode($("#" + ContorlId).html()));
    }
    CloseParamDialog();
}
function CloseParamDialog() {
    layer.close(project);
}
/** 数字金额大写转换(可以处理整数,小数,负数) */
var digitUppercase = function (n) {
    var fraction = ['角', '分'];
    var digit = [
        '零', '壹', '贰', '叁', '肆',
        '伍', '陆', '柒', '捌', '玖'
    ];
    var unit = [
        ['', '万', '亿'],
        ['', '拾', '佰', '仟']
    ];
    var head = n < 0 ? '欠' : '';
    n = Math.abs(n) * 10000;
    var s = '';
    for (var i = 0; i < fraction.length; i++) {
        s += (digit[Math.floor(n * 10 * Math.pow(10, i)) % 10] + fraction[i]).replace(/零./, '');
    }
    s = s;
    n = Math.floor(n);
    for (var i = 0; i < unit[0].length && n > 0; i++) {
        var p = '';
        for (var j = 0; j < unit[1].length && n > 0; j++) {
            p = digit[n % 10] + unit[1][j] + p;
            n = Math.floor(n / 10);
        }
        s = p.replace(/(零.)*零$/, '').replace(/^$/, '零') + unit[0][i] + s;
    }
    return head + s.replace(/(零.)*零/, '')
        .replace(/(零.)+/g, '零')
        .replace(/^整$/, '');
}
var Base64 = {
    // 转码表
    table: [
            'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H',
            'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P',
            'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X',
            'Y', 'Z', 'a', 'b', 'c', 'd', 'e', 'f',
            'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n',
            'o', 'p', 'q', 'r', 's', 't', 'u', 'v',
            'w', 'x', 'y', 'z', '0', '1', '2', '3',
            '4', '5', '6', '7', '8', '9', '+', '/'
    ],
    UTF16ToUTF8: function (str) {
        var res = [], len = str.length;
        for (var i = 0; i < len; i++) {
            var code = str.charCodeAt(i);
            if (code > 0x0000 && code <= 0x007F) {
                // 单字节，这里并不考虑0x0000，因为它是空字节
                // U+00000000 – U+0000007F  0xxxxxxx
                res.push(str.charAt(i));
            } else if (code >= 0x0080 && code <= 0x07FF) {
                // 双字节
                // U+00000080 – U+000007FF  110xxxxx 10xxxxxx
                // 110xxxxx
                var byte1 = 0xC0 | ((code >> 6) & 0x1F);
                // 10xxxxxx
                var byte2 = 0x80 | (code & 0x3F);
                res.push(
                    String.fromCharCode(byte1),
                    String.fromCharCode(byte2)
                );
            } else if (code >= 0x0800 && code <= 0xFFFF) {
                // 三字节
                // U+00000800 – U+0000FFFF  1110xxxx 10xxxxxx 10xxxxxx
                // 1110xxxx
                var byte1 = 0xE0 | ((code >> 12) & 0x0F);
                // 10xxxxxx
                var byte2 = 0x80 | ((code >> 6) & 0x3F);
                // 10xxxxxx
                var byte3 = 0x80 | (code & 0x3F);
                res.push(
                    String.fromCharCode(byte1),
                    String.fromCharCode(byte2),
                    String.fromCharCode(byte3)
                );
            } else if (code >= 0x00010000 && code <= 0x001FFFFF) {
                // 四字节
                // U+00010000 – U+001FFFFF  11110xxx 10xxxxxx 10xxxxxx 10xxxxxx
            } else if (code >= 0x00200000 && code <= 0x03FFFFFF) {
                // 五字节
                // U+00200000 – U+03FFFFFF  111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx
            } else /** if (code >= 0x04000000 && code <= 0x7FFFFFFF)*/ {
                // 六字节
                // U+04000000 – U+7FFFFFFF  1111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx
            }
        }

        return res.join('');
    },
    UTF8ToUTF16: function (str) {
        var res = [], len = str.length;
        var i = 0;
        for (var i = 0; i < len; i++) {
            var code = str.charCodeAt(i);
            // 对第一个字节进行判断
            if (((code >> 7) & 0xFF) == 0x0) {
                // 单字节
                // 0xxxxxxx
                res.push(str.charAt(i));
            } else if (((code >> 5) & 0xFF) == 0x6) {
                // 双字节
                // 110xxxxx 10xxxxxx
                var code2 = str.charCodeAt(++i);
                var byte1 = (code & 0x1F) << 6;
                var byte2 = code2 & 0x3F;
                var utf16 = byte1 | byte2;
                res.push(Sting.fromCharCode(utf16));
            } else if (((code >> 4) & 0xFF) == 0xE) {
                // 三字节
                // 1110xxxx 10xxxxxx 10xxxxxx
                var code2 = str.charCodeAt(++i);
                var code3 = str.charCodeAt(++i);
                var byte1 = (code << 4) | ((code2 >> 2) & 0x0F);
                var byte2 = ((code2 & 0x03) << 6) | (code3 & 0x3F);
                utf16 = ((byte1 & 0x00FF) << 8) | byte2
                res.push(String.fromCharCode(utf16));
            } else if (((code >> 3) & 0xFF) == 0x1E) {
                // 四字节
                // 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx
            } else if (((code >> 2) & 0xFF) == 0x3E) {
                // 五字节
                // 111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx
            } else /** if (((code >> 1) & 0xFF) == 0x7E)*/ {
                // 六字节
                // 1111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx
            }
        }

        return res.join('');
    },
    encode: function (str) {
        if (!str) {
            return '';
        }
        var utf8 = this.UTF16ToUTF8(str); // 转成UTF8
        var i = 0; // 遍历索引
        var len = utf8.length;
        var res = [];
        while (i < len) {
            var c1 = utf8.charCodeAt(i++) & 0xFF;
            res.push(this.table[c1 >> 2]);
            // 需要补2个=
            if (i == len) {
                res.push(this.table[(c1 & 0x3) << 4]);
                res.push('==');
                break;
            }
            var c2 = utf8.charCodeAt(i++);
            // 需要补1个=
            if (i == len) {
                res.push(this.table[((c1 & 0x3) << 4) | ((c2 >> 4) & 0x0F)]);
                res.push(this.table[(c2 & 0x0F) << 2]);
                res.push('=');
                break;
            }
            var c3 = utf8.charCodeAt(i++);
            res.push(this.table[((c1 & 0x3) << 4) | ((c2 >> 4) & 0x0F)]);
            res.push(this.table[((c2 & 0x0F) << 2) | ((c3 & 0xC0) >> 6)]);
            res.push(this.table[c3 & 0x3F]);
        }

        return res.join('');
    },
    decode: function (str) {
        if (!str) {
            return '';
        }

        var len = str.length;
        var i = 0;
        var res = [];

        while (i < len) {
            code1 = this.table.indexOf(str.charAt(i++));
            code2 = this.table.indexOf(str.charAt(i++));
            code3 = this.table.indexOf(str.charAt(i++));
            code4 = this.table.indexOf(str.charAt(i++));

            c1 = (code1 << 2) | (code2 >> 4);
            c2 = ((code2 & 0xF) << 4) | (code3 >> 2);
            c3 = ((code3 & 0x3) << 6) | code4;

            res.push(String.fromCharCode(c1));

            if (code3 != 64) {
                res.push(String.fromCharCode(c2));
            }
            if (code4 != 64) {
                res.push(String.fromCharCode(c3));
            }

        }

        return this.UTF8ToUTF16(res.join(''));
    }
};
</script>